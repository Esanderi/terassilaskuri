<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <title>Terassilaskuri Pro (m)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { max-width: 500px; width: 100%; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; }
        input, select, button { width: 100%; padding: 12px; margin-top: 5px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: #27ae60; color: white; border: none; font-size: 18px; cursor: pointer; font-weight: bold; }
        .result-card { margin-top: 20px; padding: 20px; background: #e8f5e9; border-radius: 10px; border-left: 6px solid #27ae60; display:none; }
        .profit-box { margin-top: 15px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 1px dashed #ff9800; }
        .status { font-size: 0.8em; margin-bottom: 10px; color: #666; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>üõ† Terassilaskuri Pro</h2>
    <div id="status" class="status">Yhdistet√§√§n Sheetsiin...</div>
    
    <div class="input-group">
        <label>Terassin koko (m¬≤):</label>
        <input type="number" id="sqm" placeholder="Esim. 15" oninput="laske()">
    </div>

    <div class="input-group">
        <label>Valitse materiaali/leveys:</label>
        <select id="matSelector" onchange="laske()"></select>
    </div>

    <button onclick="laske()">Laske Tarjous</button>

    <div id="result" class="result-card">
        <h3 id="outTotal"></h3>
        <p id="outInfo"></p>
        <div class="profit-box" id="outProfit"></div>
    </div>
</div>

<script>
    // VAIHDA T√ÑH√ÑN OMA GOOGLE SHEETS CSV-LINKKISI
    const sheetsUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTnibiziK4ikV5zszCG-zOD_Ofb1i4_MO1JVeVpxpVfAcFIw-bgpOsNrzuFwk7SP4a6NNGngLqM2oS/pub?output=csv"; 

    let hinnastoData = [];

    function laske() {
        const sqm = parseFloat(document.getElementById('sqm').value);
        const selector = document.getElementById('matSelector');
        if (!sqm || sqm <= 0 || hinnastoData.length === 0) return;
        
        const mat = hinnastoData[selector.selectedIndex];

        // LASKENTA: Metri -> Neli√∂ (sis. 5mm rako)
        // Kaava: 1000 / (leveys + 5) = kuinka monta metri√§ lautaa menee neli√∂√∂n
        const menekkiPerM2 = 1000 / (mat.leveys + 5); 
        
        // Lasketaan neli√∂hinnat metrihintojen perusteella
        const myyntiNeliohinta = mat.myyntiM * menekkiPerM2;
        const kuluNeliohinta = mat.kuluM * menekkiPerM2;

        const aloituskulu = 600; 
        const kokonaishinta = aloituskulu + (sqm * myyntiNeliohinta);
        const kokonaiskulut = sqm * kuluNeliohinta;
        const kate = kokonaishinta - kokonaiskulut;
        
        const kokonaisMetrit = Math.round(sqm * menekkiPerM2);

        document.getElementById('result').style.display = "block";
        document.getElementById('outTotal').innerText = "Tarjous: " + Math.round(kokonaishinta).toLocaleString('fi-FI') + " ‚Ç¨";
        document.getElementById('outInfo').innerText = "Menekki: n. " + kokonaisMetrit + " m (" + mat.leveys + " mm lauta)";
        
        document.getElementById('outProfit').innerHTML = "<strong>Yritt√§j√§n n√§kym√§:</strong><br>" + 
            "üí∞ Kate: " + Math.round(kate).toLocaleString('fi-FI') + " ‚Ç¨<br>" +
            "üìè Menekki: " + Math.round(menekkiPerM2 * 10) / 10 + " m / m¬≤";
    }

    async function lataaSheetsista() {
        try {
            const response = await fetch(sheetsUrl);
            const csvText = await response.text();
            const rivit = csvText.split(/\r?\n/).slice(1); 
            
            const selector = document.getElementById('matSelector');
            selector.innerHTML = ""; 
            hinnastoData = []; 

            rivit.forEach(rivi => {
                const s = rivi.split(/[;,]/);
                if(s.length >= 4) {
                    const nimi = s[0].trim();
                    const hinta = parseFloat(s[1].replace(',', '.'));
                    const kulu = parseFloat(s[2].replace(',', '.'));
                    const leveys = parseFloat(s[3].replace(',', '.'));

                    if(!isNaN(hinta) && hinta > 0) {
                        hinnastoData.push({ nimi, myyntiM: hinta, kuluM: kulu, leveys: leveys });
                        let opt = document.createElement('option');
                        opt.text = nimi + " (" + leveys + "mm)";
                        selector.appendChild(opt);
                    }
                }
            });
            document.getElementById('status').innerText = "‚úÖ Hinnasto ladattu (" + hinnastoData.length + " tuotetta)";
        } catch (e) {
            document.getElementById('status').innerText = "‚ö†Ô∏è Virhe haussa. Tarkista linkki!";
        }
    }

    lataaSheetsista();
</script>
</body>
</html>
