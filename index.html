<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <title>AI-Terassilaskuri Pro</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { max-width: 550px; width: 100%; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; }
        input, select, button { width: 100%; padding: 12px; margin-top: 5px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: #27ae60; color: white; border: none; font-size: 18px; cursor: pointer; font-weight: bold; }
        .result-card { margin-top: 20px; padding: 20px; background: #e8f5e9; border-radius: 10px; border-left: 6px solid #27ae60; display:none; }
        .prediction-box { margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 1px solid #2196f3; font-size: 0.9em; }
        .status { font-size: 0.8em; margin-bottom: 10px; color: #666; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>üõ† Ennustava Terassilaskuri</h2>
    <div id="status" class="status">Yhdistet√§√§n tietokantoihin...</div>
    
    <div class="input-group">
        <label>Uuden terassin koko (m¬≤):</label>
        <input type="number" id="sqm" placeholder="Esim. 20" oninput="laske()">
    </div>

    <div class="input-group">
        <label>Valitse materiaali:</label>
        <select id="matSelector" onchange="laske()"></select>
    </div>

    <button onclick="laske()">Laske √Ñlyk√§s Ennuste</button>

    <div id="result" class="result-card">
        <h3 id="outTotal"></h3>
        <p id="outInfo"></p>
        <div class="prediction-box" id="outPrediction"></div>
    </div>
</div>

<script>
    const hinnatUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTnibizIk4iKv52vSzCG-zOD_Ofb1i4_MO1JVeVpxpVfAcFIw-bgpOsNrzuFwk7SP4a6NNGngLqM2oS/pub?gid=1460133489&single=true&output=csv"; 
    const historiaUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTnibizIk4iKv52vSzCG-zOD_Ofb1i4_MO1JVeVpxpVfAcFIw-bgpOsNrzuFwk7SP4a6NNGngLqM2oS/pub?gid=515629452&single=true&output=csv"; 

    let hinnastoData = [];
    let historiaData = [];

    async function lataaData() {
        try {
            // Ladataan hinnat
            const hRes = await fetch(hinnatUrl);
            const hCsv = await hRes.text();
            hinnastoData = hCsv.split(/\r?\n/).slice(1).map(r => {
                const s = r.split(/[;,]/);
                return { nimi: s[0], hinta: parseFloat(s[1]), kulu: parseFloat(s[2]), leveys: parseFloat(s[3]) };
            });

            // Ladataan historia
            const histRes = await fetch(historiaUrl);
            const histCsv = await histRes.text();
            historiaData = histCsv.split(/\r?\n/).slice(1).map(r => {
                const s = r.split(/[;,]/);
                return { materiaali: s[0], koko: parseFloat(s[1]), hinta: parseFloat(s[2]) };
            });

            paivitaValikko();
            document.getElementById('status').innerText = "‚úÖ Hinnat ja historia k√§yt√∂ss√§";
        } catch (e) {
            document.getElementById('status').innerText = "‚ö†Ô∏è Virhe datan haussa";
        }
    }

    function paivitaValikko() {
        const sel = document.getElementById('matSelector');
        hinnastoData.forEach(m => {
            if(m.nimi) {
                let opt = document.createElement('option');
                opt.text = m.nimi + " (" + m.leveys + "mm)";
                sel.appendChild(opt);
            }
        });
    }

    function laske() {
        const sqm = parseFloat(document.getElementById('sqm').value);
        const mat = hinnastoData[document.getElementById('matSelector').selectedIndex];
        if (!sqm || !mat) return;

        // 1. Laske nykyhetken materiaalikulu
        const menekkiM = 1000 / (mat.leveys + 5);
        const matKuluYhteensa = sqm * menekkiM * mat.kulu;

        // 2. Laske historiallinen keskihinta (ty√∂ + kate)
        // Etsit√§√§n historiasta samat materiaalit
        const samatTyot = historiaData.filter(h => h.materiaali === mat.nimi);
        let avgTyopalkkaM2 = 120; // Oletus jos historiaa ei ole

        if(samatTyot.length > 0) {
            const summat = samatTyot.map(h => h.hinta / h.koko);
            avgTyopalkkaM2 = summat.reduce((a,b) => a+b) / summat.length;
        }

        // 3. Yhdistet√§√§n: (Nykyinen materiaalikulu) + (Historiallinen ty√∂n osuus)
        // Lis√§t√§√§n viel√§ 600‚Ç¨ aloitusvarmistus
        const ennuste = 600 + matKuluYhteensa + (sqm * (avgTyopalkkaM2 - 50)); 

        document.getElementById('result').style.display = "block";
        document.getElementById('outTotal').innerText = "Ennuste: " + Math.round(ennuste).toLocaleString() + " ‚Ç¨";
        document.getElementById('outInfo').innerText = "Nykyinen puun hinta: " + mat.kulu + " ‚Ç¨/m";
        document.getElementById('outPrediction').innerHTML = "<strong>üí° Historiaan perustuva analyysi:</strong><br>" +
            "Aiempi keskihinta t√§lle materiaalille: " + Math.round(avgTyopalkkaM2) + " ‚Ç¨/m¬≤<br>" +
            "Suositeltu tarjous nykyisill√§ kuluilla.";
    }

    lataaData();
</script>
</body>
</html>
